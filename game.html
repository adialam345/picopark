<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="./libs/common.js"></script>
    <script src="./libs/matter.min.js"></script>
    <script src="./libs/matterjsRaycast.js"></script>
    <script src="./libs/peer.js"></script>
    <script src="libs/words.js"></script>

    <link rel="icon" href="./assets/imgs/favicon.png">
    <title id="title">Microscopic Natural Area for Public Recreational Activities</title>

    <style>
        @font-face {
            font-family: squareforced;
            src: local('FORCEDSQUARE'), url(./assets/FORCEDSQUARE.ttf) format('truetype');

        }
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'squareforced', Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }
        .overlay {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .overlay a {
            color: #4CAF50;
            text-decoration: none;
            margin: 0 5px;
        }
        .overlay a:hover {
            text-decoration: underline;
        }
        #mobileControls {
            display: none;
            position: fixed;
            bottom: 10px;
            left: 0;
            right: 0;
            z-index: 100;
            text-align: center;
        }
        .control-button {
            width: 50px;
            height: 50px;
            margin: 5px;
            border-radius: 50%;
            background: rgba(76, 175, 80, 0.8);
            border: none;
            color: white;
            font-size: 20px;
            touch-action: none;
            user-select: none;
        }
        #leftBtn {
            position: fixed;
            bottom: 10px;
            left: 10px;
        }
        #rightBtn {
            position: fixed;
            bottom: 10px;
            left: 70px;
        }
        #jumpBtn {
            position: fixed;
            bottom: 10px;
            right: 10px;
        }
        #downBtn {
            position: fixed;
            bottom: 10px;
            right: 70px;
        }
        #orientationWarning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            text-align: center;
            padding-top: 40%;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        .menu-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2a2a2a;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            color: white;
            z-index: 1000;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
            max-width: 400px;
        }
        .menu-container h1 {
            font-size: 1.5rem;
            margin: 0 0 1rem 0;
            color: #4CAF50;
        }
        .menu-container h2 {
            color: #4CAF50;
            margin: 0.5rem 0;
            font-size: 1.2rem;
        }
        .room-code {
            font-size: 1.5rem;
            margin: 1rem 0;
            padding: 0.8rem;
            background-color: #333;
            border-radius: 5px;
            color: #4CAF50;
        }
        .menu-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            margin: 0.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.3s, transform 0.2s;
            width: auto;
            min-width: 120px;
        }
        .menu-button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }
        .menu-button:active {
            transform: scale(0.95);
        }
        .mobile-controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
        }
        .mobile-controls button {
            background-color: rgba(76, 175, 80, 0.8);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .mobile-controls button:active {
            background-color: rgba(69, 160, 73, 0.8);
            transform: scale(0.95);
        }
        .orientation-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #1a1a1a;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            z-index: 2000;
        }
        .orientation-warning h2 {
            color: #4CAF50;
            margin-bottom: 1rem;
        }
        @media (min-width: 768px) {
            .mobile-controls {
                display: none;
            }
        }
        .member-list {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 150px;
            overflow-y: auto;
        }
        .member-list div {
            padding: 5px;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .game-code {
            font-size: 1.2rem;
            color: #4CAF50;
            margin: 10px 0;
            word-break: break-all;
        }
        .copy-link {
            color: #4CAF50;
            text-decoration: none;
            font-size: 14px;
        }
        .copy-link:hover {
            text-decoration: underline;
        }
        @media (orientation: landscape) {
            .menu-container {
                padding: 1rem;
                max-height: 80vh;
            }
            .menu-container h1 {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
            }
            .menu-button {
                padding: 0.6rem 1.2rem;
                margin: 0.3rem;
                font-size: 0.8rem;
                min-width: 100px;
            }
            .member-list {
                max-height: 100px;
            }
            .control-button {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            #rightBtn {
                left: 60px;
            }
            #downBtn {
                right: 60px;
            }
        }
    </style>
</head>
<body>
    <div id="orientationWarning">
        Please rotate your device to landscape mode to play the game.
    </div>

    <canvas id="c" style="display: none;"></canvas>
    <div class="overlay">
        <a href="./index.html">Back to Home</a> | 
        <a style="display: none;" id="restartLevel" href="#"  onClick="(function(){
            mainGame.levelHandler.setLevel(mainGame.levelHandler.currentLevel.name)
            return false;
        })();return false;">Restart Level</a>
    </div>

    <div id="mobileControls">
        <button id="leftBtn" class="control-button">←</button>
        <button id="rightBtn" class="control-button">→</button>
        <button id="jumpBtn" class="control-button">↑</button>
        <button id="downBtn" class="control-button">↓</button>
    </div>

    <script>
        // Define isMobile globally
        window.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isMobile = window.isMobile;
        let controlsVisible = false;
        
        // Ensure keys object exists globally
        window.keys = window.keys || {};

        // URL parsing
        var url = location.href;
        var params = new URLSearchParams(window.location.search);
        var urlData = {};
        
        // Parse URL parameters properly
        for (let [key, value] of params) {
            urlData[key] = value;
        }

        // Clean up join ID if present (remove any additional parameters)
        if (urlData.join) {
            urlData.join = urlData.join.split('&')[0];
        }

        console.log("URL Data:", urlData);

        data = {};
        urlData.forEach((e)=>{
            data[e.split("=")[0]] = e.split("=")[1];
        });

        urlData = data;

        // Orientation check functions
        function checkOrientation() {
            if (isMobile) {
                const warning = document.getElementById('orientationWarning');
                const controls = document.getElementById('mobileControls');
                
                if (window.innerHeight > window.innerWidth) {
                    warning.style.display = 'block';
                    controls.style.display = 'none';
                    controlsVisible = false;
                } else {
                    warning.style.display = 'none';
                    // Only show controls if game is initialized and running
                    if (window.mainGame && window.mainGame.running) {
                        controls.style.display = 'block';
                        controlsVisible = true;
                    }
                }
            }
        }

        function showMobileControls() {
            if (isMobile && window.innerHeight < window.innerWidth && window.mainGame && window.mainGame.running) {
                console.log("Showing mobile controls");
                const controls = document.getElementById('mobileControls');
                controls.style.display = 'block';
                controlsVisible = true;
            }
        }

        function checkAndShowControls() {
            // Only check if mainGame exists
            if (typeof window.mainGame !== 'undefined' && window.mainGame) {
                if (isMobile && window.mainGame.running && !controlsVisible && window.innerHeight < window.innerWidth) {
                    showMobileControls();
                }
            }
        }

        // Initial orientation check (just for warning)
        function initialOrientationCheck() {
            if (isMobile) {
                const warning = document.getElementById('orientationWarning');
                if (window.innerHeight > window.innerWidth) {
                    warning.style.display = 'block';
                } else {
                    warning.style.display = 'none';
                }
            }
        }

        // Listen for orientation changes
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', checkOrientation);

        // Do initial orientation check (just for warning)
        initialOrientationCheck();

        // Start checking for controls only after game might be initialized
        setTimeout(() => {
            // Regular interval to ensure controls are visible when needed
            setInterval(checkAndShowControls, 1000);
        }, 2000); // Wait 2 seconds before starting the interval

        // Store original game functions after they are defined
        const originalStartGame = window.startGame;
        window.startGame = function() {
            console.log("Starting game...");
            if (originalStartGame) originalStartGame();
            
            // Show mobile controls if needed
            if (isMobile && window.mainGame && window.mainGame.running) {
                setTimeout(showMobileControls, 500);
            }
        };

        // Override startMainGame
        window.startMainGame = function() {
            if (gameStartFunctions.startMainGame) gameStartFunctions.startMainGame();
            if (window.mainGame) {
                mainGame.testInit();
                mainGame.initRender();
                showMobileControls();
            }
        };
    </script>

    <!-- Load all game scripts -->
    <script src="./src/multiplayer.js"></script>
    <script src="./src/buttons.js"></script>
    <script src="./src/door.js"></script>
    <script src="./src/trigger.js"></script>
    <script src="./src/blocks.js"></script>
    <script src="./src/lasers.js"></script>
    <script src="./src/jumppad.js"></script>

    <script src="./src/levels.js"></script>
    <script src="./src/level.js"></script>

    <script src="./src/matterInit.js"></script>
    <script src="./src/atlasSetup.js"></script>

    <script src="src/syncController.js"></script>

    <script src="./src/controls.js"></script>
    <script src="./src/update.js"></script>

    <script src="./src/player.js"></script>
    <script src="./src/render.js"></script>

    <script src="./src/entity.js"></script>
    <script src="src/particles.js"></script>

    <script src="./src/game.js"></script>

    <script src="./src/constraints.js"></script>

    <script src="./src/host.js"></script>
    <script src="./src/client.js"></script>

    <script src="./src/menu.js"></script>

    <div id="menu" class="menu-container">
        <h1 class="game-title">Microscopic Natural Area for Public Recreational Activities</h1>
        <div id="host" style="display: none;" class="menu-section">
            <div id="gameDetails">
                <div id="gameCode" class="game-code">Code: <b id="roomCode">fetching</b><span id="incoming"></span></div>
                <a id="copyLink" href="#" class="copy-link" onclick="(function(){
        navigator.clipboard.writeText(`https://aeolus-1.github.io/picoParkClone/game.html?join=${hostConnection.joinConn.selfId}`);
        return false;
    })();return false;">[Copy Link]</a>
            </div>
            <div id="memberList" class="member-list">
                <h2>Members:</h2>
                <div id="memberlist"></div>
                <div>Host<br></div>
            </div>
            <button class="menu-button" onClick="(function(){
                mainGame.playerhandler.addPlayer({
                    controls:['a','d','w','s'],
                    keys:keys,
                    color:mainGame.fetchColor(),
                })
                addPlayerToMenu('Player2')
                return false;
            })();return false;">Add Local Co-op Player</button>
            <hr style="border-color: rgba(255,255,255,0.1); margin: 15px 0;">
            <button class="menu-button" onClick="(function(){
                startGame()
                hostConnection.broadcast(JSON.stringify({
                    startGame:true,
                }))
                return false;
            })();return false;">Start Game</button>
            </div>

        <div id="join" style="display: none;" class="menu-section">
            <div class="game-code">Waiting for host to start...</div>
            <div class="member-list">
                <div>Connected to room</div>
            </div>
        </div>
    </div>

    <script>
        window.localfile = location.protocol=="file:";
        
        // Define core game functions first
        function startMainGame() {
            mainGame.testInit();
            mainGame.initRender();
        }

        function startGame() {
            mainGame.testInit();
            mainGame.initRender();
            document.getElementById("menu").style.display = "none";
            document.getElementById("c").style.display = "";
            mainGame.running = true;
        }
        
        function initGame() {
            window.mainGame = new Game();

            // Set up controls based on device type
            const controls = ["arrowleft", "arrowright", "arrowup", "arrowdown"];

            var player1 = mainGame.playerhandler.addPlayer({
                controls: controls,
                keys: window.keys || {},
            });

            window.hostConnection;
            window.clientConnection;
            if (urlData.host) {
                hostConnection = new Host(mainGame);
                hostConnection.init();
            }
            if (urlData.join) {
                clientConnection = new Client(mainGame, player1);
                clientConnection.init(urlData.join);
                document.getElementById("restartLevel").style.display = "none";
            }
            if (!urlData.host && !urlData.join) startGame();

            // Simple update intervals like in the original
            setInterval(() => {
                if (window.hostConnection) hostConnection.updateClients();
                if (window.clientConnection) clientConnection.updateHost();
            }, 10); // Original 10ms interval

            setInterval(() => {
                mainGame.players.forEach((e) => {
                    if (!e.onlinePlayer) e.updateKeys(window.keys || {});
                });
            }, 5); // Original 5ms interval
        }

        // Initialize game when window loads
        window.onload = () => {
            _loadFont("squareforced");

            if (urlData.host) {
                document.getElementById("host").style.display = "";
            } else if (urlData.join) {
                document.getElementById("join").style.display = "";
            }

            initGame();

            let tempLevel = localStorage.getItem("tempLevel");
            console.log(tempLevel);
            if (tempLevel != null) {
                let levelString = `({${atob(tempLevel)}})`;
                document.getElementById("gameCode").innerHTML = "-- temp level loaded --";
                document.getElementById("title").textContent = "temp-level";
                document.getElementById("copyLink").style.display = "none";
                levels.tempLevel = eval(levelString)["tempName"];
                mainGame.runTemp = true;
                localStorage.removeItem("tempLevel");
            }
        }

        function setLevel(lvl) {
            mainGame.renderer.levelTransistion(lvl);
                            if (window.hostConnection) {
                                hostConnection.broadcast(JSON.stringify({
                    setLevel: lvl,
                }));
            }
        }
    </script>

    <!-- Mobile controls setup -->
    <script>
        if (isMobile) {
            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');
            const jumpBtn = document.getElementById('jumpBtn');
            const downBtn = document.getElementById('downBtn');
            let isJumping = false;

            // Touch events for left button
            leftBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (window.mainGame && window.mainGame.running) {
                    window.keys['arrowleft'] = true;
                    if (window.clientConnection) {
                        window.clientConnection.updateKey('arrowleft', true);
                    }
                }
            });

            leftBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (window.mainGame && window.mainGame.running) {
                    window.keys['arrowleft'] = false;
                    if (window.clientConnection) {
                        window.clientConnection.updateKey('arrowleft', false);
                    }
                }
            });

            // Touch events for right button
            rightBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (window.mainGame && window.mainGame.running) {
                    window.keys['arrowright'] = true;
                    if (window.clientConnection) {
                        window.clientConnection.updateKey('arrowright', true);
                    }
                }
            });

            rightBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (window.mainGame && window.mainGame.running) {
                    window.keys['arrowright'] = false;
                    if (window.clientConnection) {
                        window.clientConnection.updateKey('arrowright', false);
                    }
                }
            });

            // Touch events for jump button
            jumpBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (window.mainGame && window.mainGame.running && !isJumping) {
                    isJumping = true;
                    window.keys['arrowup'] = true;
                    if (window.clientConnection) {
                        window.clientConnection.updateKey('arrowup', true);
                    }
                }
            });

            jumpBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (window.mainGame && window.mainGame.running) {
                    window.keys['arrowup'] = false;
                    if (window.clientConnection) {
                        window.clientConnection.updateKey('arrowup', false);
                    }
                    setTimeout(() => {
                        isJumping = false;
                    }, 250);
                }
            });

            // Touch events for down button
            downBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (window.mainGame && window.mainGame.running) {
                    window.keys['arrowdown'] = true;
                    if (window.clientConnection) {
                        window.clientConnection.updateKey('arrowdown', true);
                    }
                }
            });

            downBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (window.mainGame && window.mainGame.running) {
                    window.keys['arrowdown'] = false;
                    if (window.clientConnection) {
                        window.clientConnection.updateKey('arrowdown', false);
                    }
                }
            });

            // Add touchcancel handlers for safety
            ['leftBtn', 'rightBtn', 'jumpBtn', 'downBtn'].forEach(btnId => {
                document.getElementById(btnId).addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    if (window.mainGame && window.mainGame.running) {
                        const keyMap = {
                            'leftBtn': 'arrowleft',
                            'rightBtn': 'arrowright',
                            'jumpBtn': 'arrowup',
                            'downBtn': 'arrowdown'
                        };
                        window.keys[keyMap[btnId]] = false;
                        if (window.clientConnection) {
                            window.clientConnection.updateKey(keyMap[btnId], false);
                        }
                    }
                });
            });

            // Prevent default touch behaviors
            document.addEventListener('touchmove', (e) => {
                if (e.target.classList.contains('control-button')) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // Add visibility change handler
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && isMobile) {
                checkAndShowControls();
            }
        });
    </script>

    <!-- Remove all debug logging -->
</body>
</html>
